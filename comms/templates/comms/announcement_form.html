{% extends "dashboard_base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">New Announcement</h4>
  <a class="btn btn-outline-secondary btn-sm" href="{% url 'announcement_list' %}">Cancel</a>
</div>

<form method="post" class="card p-3">
  {% csrf_token %}

  <div class="mb-3">
    <label class="form-label">Title</label>
    <input type="text" name="title" class="form-control" value="{{ form.title.value|default_if_none:'' }}" required>
    {% if form.title.errors %}<div class="text-danger small">{{ form.title.errors }}</div>{% endif %}
  </div>

  <div class="mb-3">
    <label class="form-label">Content</label>
    <textarea name="content" class="form-control" rows="6">{{ form.content.value|default_if_none:'' }}</textarea>
    {% if form.content.errors %}<div class="text-danger small">{{ form.content.errors }}</div>{% endif %}
  </div>

  <div class="mb-3">
    <label class="form-label">Departments (leave empty for Global)</label>
    <select name="departments" class="form-select" multiple>
      {% for d in form.departments.field.queryset %}
        <option value="{{ d.id }}" {% if d.id in form.departments.value %}selected{% endif %}>{{ d.name }}</option>
      {% endfor %}
    </select>
    {% if form.departments.field.queryset|length == 0 %}
      <div class="text-muted small mt-1">
        No departments available.
        {% if request.user.role == 'MANAGER' %}
          You aren't assigned as a manager to any department yet. Ask an admin/GM to add you as a manager.
        {% endif %}
      </div>
    {% endif %}
    {% if form.departments.errors %}<div class="text-danger small">{{ form.departments.errors }}</div>{% endif %}
  </div>

  <div class="row g-3">
    <div class="col-md-4">
      <div class="form-check mt-4">
        <input class="form-check-input" type="checkbox" name="pinned" id="id_pinned" {% if form.pinned.value %}checked{% endif %}>
        <label class="form-check-label" for="id_pinned">Pinned</label>
      </div>
    </div>
    <div class="col-md-4">
      <label class="form-label">Publish at</label>
      {{ form.publish_at }}
      {% if form.publish_at.errors %}<div class="text-danger small">{{ form.publish_at.errors }}</div>{% endif %}
    </div>
    <div class="col-md-4">
      <label class="form-label">Expire at</label>
      {{ form.expire_at }}
      {% if form.expire_at.errors %}<div class="text-danger small">{{ form.expire_at.errors }}</div>{% endif %}
    </div>
  </div>

  <div class="mt-3">
    <label class="form-label">Status</label>
    {{ form.status }}
    <div class="form-text">Managers can only publish to their managed departments. Global publish is only available to GM/Admin.</div>
    {% if form.non_field_errors %}<div class="text-danger small mt-2">{{ form.non_field_errors }}</div>{% endif %}
  </div>

  <div class="mt-3">
    <button class="btn btn-primary" type="submit">Create</button>
  </div>
</form>
{% endblock %}
